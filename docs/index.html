<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Project of Data Visualization</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
        img {
            width: 200px;
            border-radius: 50%;
        }

        figure {
            display: inline-block;
        }

        figcaption {
            margin: 10px;
            width: 100%;
            text-align: center;
        }

        footer {
            width: 100%;
            text-align: center;
        }

        body {
            background-color: whitesmoke;
            text-align: center;
            color: black;
        }
        p{
            width: 75%;
            padding: 20px;
            margin: 20px auto;
            text-align:start;
          
            background-color: gainsboro;
            border-radius: 20px 20px 20px 20px;
        }
        ul{
            text-align: start;
            width: 300px;
            padding: 20px;
        }
        h3{
            color: red;
        }
        #viz{
            width: 100%;
            background-color: white;
            text-align: start;
            padding: 0px;
            margin: 0px;
        }
        #board{
            width: 60%;
            margin: 10px auto;
            text-align: center;
            height: 100px;
            background-color: #ddd;
            border: thick gray solid;
            border-radius: 20px 10px;
            line-height: 100px;
            color: black;
            font-weight: bolder;
        }
    </style>
</head>

<body>
    <h1>Project of Data Visualization</h1>
    <h2>Milestone 2 (Friday 1st May, 5pm)</h2>
    
    <h3>Data && motivation</h3>
    <p>
        The main focus of our project is to test the too-much-talent effect in European football.
        The data that we use contains a large set of match results and other meaningful information
        across several European leagues. We intend to use this data to build several measures of 
        team performance. Data from the popular FIFA series of video games is also available and will
        allow us to measure individual player attributes which we can then aggregate to measure team talent.
        
        The visualisation will be focused around comparing the designed metrics under user-specified filters 
        (team, country, season ...). The main tool will be a large interactive scatter plot where the user 
        will be able to contrast the theory. We intend to give readers a diverse selection of statistics so 
        that they can obtain rich insights into this phenomenon.

        We may also include other visualisation tools more centered on teams, leagues or players, that will 
        please the readers’ curiosity but that are not as focused around the too-much-talent-effect. Some examples of this could be: 
        <b>team performance over time</b>,
        <b>player talent over time</b>,
        <b>compare leagues based on player talent</b>.    

        Depending on the source (all leagues don’t have the same amount of data collected), the data set can be very rich and contain 
        other interesting information such as goal scorers, penalty cards and player substitution which are not always directly related
        to a team’s success but could lead to interesting visualisation as well.
    </p>
    <h3>Website && ideas</h3>
    <p>
        We intend to have a main menu in which the user can select what kind of statistics he wants to test and visualise. This menu 
        would contain several categories such as players, teams, leagues and the-too-much-talent effect. The first three would be more
        “raw plots” without any interpretation behind, but for the fourth one, we would like include some interpretation clues to guide
        the reader and explain the main points made in the article.
        As said, we intend to use an interactive scatter plot to make connections between team performance and talent in our 
        <b>too-much-talent category</b>. However, for the other three, visualisation can very well take other forms. For 
        detailed player data, we could use star plots. To visualise a team’s match ups, we could use a circular flow chart. 
        In the league  category, we thought of maybe including a map so the user can select the country’s league he wants to visualise.
    </p>
   

    <div id="viz" style="margin: 10px auto; text-align: center;">
        <select id="league_select" style="display: block; width: fit-content; margin: 10px auto;">
            <option value="all" selected>All leagues Combined</option>
        </select>

        <select id="team_select" style="display: block; width: fit-content; margin: 10px auto;">
            <option value="all" selected>All Teams Combined</option>
        </select>
    </div>
    <div id="board">

    </div>
    
    <footer>
        <hr />
        <figure>
            <img src="https://avatars.githubusercontent.com/u/41611792?v=4">
            <figcaption>aalshabaan</figcaption>
        </figure>
        <figure>
            <img src="https://avatars.githubusercontent.com/u/55542424?v=4">
            <figcaption>alexcadillon</figcaption>
        </figure>
        <figure>
            <img src="https://avatars.githubusercontent.com/u/43466373?v=4">
            <figcaption>ksabaa15</figcaption>
        </figure>
    </footer>
    

</body>
<script>
    
    d3.csv("teams_by_season.csv", function(data){
        team_names = Array.from(new Set(data.map(element=>element.team))).sort();
        leagues_names = Array.from(new Set(data.map(e => e.league_name))).sort();
        
        function descrite(data){
            var set = new Set()
            for( var i=0; i<data.length; ++i){
                set.add(data[i].avg_overall_rating_discrete);
            }
            var intervals = Array.from(set).sort((a,b)=>(+a.substring(1,a.search(','))>+b.substring(1,b.search(',')))?1:-1);
            var array =[]
            for(var i=0; i<intervals.length; ++i){
                interval = intervals[i];
                intervalStart = +interval.substring(1,interval.search(','));
                intervalEnd = +interval.substring(interval.search(',')+1,interval.length-1);
                let average=0;
                let number =0;
                
                for(var j=0; j<(data.filter(d=>d.avg_overall_rating_discrete===interval)).length;++j){
                    filterData = data.filter(d=>d.avg_overall_rating_discrete===interval)
                    average += 100*filterData[j].perc_points;
                    number +=1;
                }
                if (average!==0 && number !==0) {
                    average= average /number;
                }

                array.push({x:Math.round((intervalEnd+intervalStart)/2), y:Math.round(average), count:number})  
            }
            return array;
        }
        var league = 'all'
        var team = 'all'

        d3.select('#league_select')
        .selectAll('option')
        .data(leagues_names)
        .enter()
        .append("option")
        .text(d => d)
        .attr('value', d => d);

        d3.select("#team_select")
        .selectAll("option")
        .data(team_names)
        .enter()
        .append("option")
        .text(function(d){return d;})
        .attr("value",function(d){return d;});

        const margin = {top: 40, right:90, bottom: 80, left: 60};
        const width = 900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;  
    
        let svg = d3.select("#viz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

        svg.append("text")             
            .attr("transform","translate(" + ((width/2)-60) + " ," + (height + margin.top + 30) + ")")
            .text("Average Player Rating");

        svg.append("text")
            .attr("transform", "rotate(270)")
            .attr("y", - margin.left/2 -10)
            .attr("x",  -height/2 -60)
            .text("Team Point Percentage");

        let xScale= d3.scaleLinear()
            .domain([45,90])
            .range([0,width]);
        let yScale = d3.scaleLinear()
            .domain([0,100])
            .range([height,0]);

        svg.append("g")
            .attr("transform","translate(0,"+height+")")
            .call(d3.axisBottom(xScale));
        svg.append("g")
            .call(d3.axisLeft(yScale));
        
        var d3data =descrite(data);

        let courbe = svg.append("g")
            .append("path")
            .datum(d3data)
            .attr("d",d3.line()
                .x(function(d){ return xScale(d.x)})
                .y(function(d){ return yScale(d.y)})
            ).attr("stroke", "red")
            .style("stroke-width",4)
            .style("fill","none");
  
        svg.selectAll("circle")
            .data(data).enter()
            .append("circle")
            .attr("cx", function(d) {return xScale(+d.team_avg_overall_rating)})
            .attr("cy", function(d) {return yScale(100*d.perc_points)})
            .attr("r", 4)
            .attr("stroke","red")
            .style("fill","black")
            .on('mouseover', function (d, i) {
                d3.select(this).transition()
                        .duration('150')
                        .attr("r", 8)
                        .style("fill","red");
                d3.select("#board")
                    .text(
                        "Season: "+d.season+" Team: "+d.team
                    );
            })
            .on('mouseout', function (d, i) {
                d3.select(this).transition()
                    .duration('250')
                    .attr("r", 4)
                    .style("fill","black");;

                d3.select("#board")
                    .select("text")
                    .remove();
            });


        d3.select("#league_select").on("change", function(d) {
            league = d3.select(this).property("value")

            let newData = data.filter(element=>element.league_name===league);
            if (league==="all"){
                d3.select('#team_select').selectedIndex = 0
                team = 'all'
                newData = data
            }

            // Populate team selector
            let team_data = d3.select('#team_select').data(newData)

            team_data.exit().remove()

            team_data.enter().append("option")
                .text(function (d) {
                    return d.team;
                })
                .attr("value", function (d) {
                    return d.team;
                })




            courbe.datum(descrite(newData))
                .transition()
                .duration(800)
                .attr("d",d3.line()
                    .x(function(d){ return xScale(d.x)})
                    .y(function(d){ return yScale(d.y)})
                );

            svg.selectAll("circle").remove();
            svg.selectAll("circle")
                .data(newData).enter()
                .append("circle")
                .attr("cx", function(d) {return xScale(+d.team_avg_overall_rating)})
                .attr("cy", function(d) {return yScale(100*d.perc_points)})
                .attr("r", 4)
                .attr("stroke","red")
                .style("fill","black")
                .on('mouseover', function (d, i) {
                    d3.select(this).transition()
                        .duration('150')
                        .attr("r", 8)
                        .style("fill","red");;
                    d3.select("#board")
                        .text(
                            "Season: "+d.season+" Team: "+d.team
                        );
                })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                        .duration('250')
                        .attr("r", 4)
                        .style("fill","black");;

                    d3.select("#board")
                        .select("text")
                        .remove();
                });
        })
            
        d3.select("#team_select").on("change", function(d) {
            team = d3.select(this).property("value")
            let newData = data.filter(element=>element.team===team);
            if (team==="all" && league === 'all'){
                newData = data
            }
            courbe.datum(descrite(newData))
            .transition()
            .duration(800)
            .attr("d",d3.line()
                .x(function(d){ return xScale(d.x)})
                .y(function(d){ return yScale(d.y)})
            );

            svg.selectAll("circle").remove();
            svg.selectAll("circle")
                .data(newData).enter()
                .append("circle")
                .attr("cx", function(d) {return xScale(+d.team_avg_overall_rating)})
                .attr("cy", function(d) {return yScale(100*d.perc_points)})
                .attr("r", 4)
                .attr("stroke","red")
                .style("fill","black")
                .on('mouseover', function (d, i) {
                d3.select(this).transition()
                            .duration('150')
                            .attr("r", 8)
                           .style("fill","red");;
                    d3.select("#board")
                        .text(
                            "Season: "+d.season+" Team: "+d.team
                        );
                })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                        .duration('250')
                        .attr("r", 4)
                        .style("fill","black");;

                    d3.select("#board")
                        .select("text")
                        .remove();
                });        
         })
    });
  </script>


</html>
